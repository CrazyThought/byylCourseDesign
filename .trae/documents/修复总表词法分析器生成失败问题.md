# 修复总表词法分析器生成失败问题

## 1. 已发现的核心问题

### 1.1 问题表现
- 能够成功生成单个正则表达式的词法分析器
- 能够成功生成总表的NFA图、DFA图和最小化DFA图
- 但在尝试生成总表词法分析器时失败，提示"请先完成DFA最小化"

### 1.2 根本原因
- 词法分析器生成函数 `on_btnGenerateLexer_clicked()` 没有处理总表视图的情况
- 总表的最小化DFA存储在 `m_totalMinimizedDFA` 变量中，而非 `m_minimizedDfaMap` 映射中
- 当选择总表视图时，`m_currentRegexName` 被设置为"总表"，但 `m_minimizedDfaMap` 中没有"总表"这个键
- 验证逻辑 `!m_minimizedDfaMap.contains(m_currentRegexName)` 导致生成失败

## 2. 修复方案

### 2.1 修复思路
1. 修改 `on_btnGenerateLexer_clicked()` 函数，添加总表视图的处理逻辑
2. 当为总表视图时，检查 `m_totalMinimizedDFA` 是否为空
3. 当为总表视图时，使用 `m_totalMinimizedDFA` 生成词法分析器
4. 否则，使用原有的逻辑处理单个正则表达式

### 2.2 修复代码

需要修改 `d:\Programmes\Qt\byylCourseDesign\byylCD\src\mainwindow.cpp` 文件中的 `on_btnGenerateLexer_clicked()` 函数，具体修改如下：

1. 修改验证逻辑，添加总表视图的特殊处理
2. 修改词法分析器生成调用，根据视图状态选择不同的最小化DFA

### 2.3 最小改动原则
- 只修改必要的代码，不影响原有功能
- 保持代码结构不变
- 不添加新的依赖或组件
- 确保修复后原有功能正常工作

## 3. 修复实施

### 3.1 修改验证逻辑
将原有的验证逻辑：
```cpp
// 检查是否已生成最小化DFA
if (m_minimizedDfaMap.isEmpty() || m_currentRegexName.isEmpty() || !m_minimizedDfaMap.contains(m_currentRegexName)) {
    ui->statusbar->showMessage("词法分析器生成失败", 3000);
    QMessageBox::warning(this, tr("警告"), tr("请先完成DFA最小化"));
    return;
}
```

修改为：
```cpp
// 检查是否已生成最小化DFA
if ((m_isTotalView && m_totalMinimizedDFA.states.isEmpty()) || 
    (!m_isTotalView && (m_minimizedDfaMap.isEmpty() || m_currentRegexName.isEmpty() || !m_minimizedDfaMap.contains(m_currentRegexName)))) {
    ui->statusbar->showMessage("词法分析器生成失败", 3000);
    QMessageBox::warning(this, tr("警告"), tr("请先完成DFA最小化"));
    return;
}
```

### 3.2 修改词法分析器生成调用
将原有的生成调用：
```cpp
// 生成词法分析器代码
QString lexerCode = m_lexerGenerator.generateLexer(m_currentRegexItems, m_minimizedDfaMap[m_currentRegexName], method);
```

修改为：
```cpp
// 生成词法分析器代码
QString lexerCode;
if (m_isTotalView) {
    lexerCode = m_lexerGenerator.generateLexer(m_currentRegexItems, m_totalMinimizedDFA, method);
} else {
    lexerCode = m_lexerGenerator.generateLexer(m_currentRegexItems, m_minimizedDfaMap[m_currentRegexName], method);
}
```

## 4. 修复复查

修复后，需要进行以下复查：
1. 检查代码语法是否正确
2. 检查逻辑是否完整
3. 确保原有功能不受影响
4. 确保总表词法分析器能够成功生成

修复后的程序将能够同时支持单个正则表达式和总表的词法分析器生成，解决当前的矛盾情况。